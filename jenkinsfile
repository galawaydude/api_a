// Jenkinsfile
pipeline {
    agent any

    // This new 'tools' block makes the scanner program available to the pipeline
    tools {
        sonarScanner 'DefaultSonarScanner'
    }

    stages {
        // ## Stage 1: Get the code from your repository
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/galawaydude/api_a.git'
            }
        }

        // ## Stage 2: Analyze the code's quality with SonarQube
        stage('SonarQube Code Analysis') {
            steps {
                withSonarQubeEnv('MySonarQubeServer') {
                    sh 'sonar-scanner'
                }
            }
        }

        // ## Stage 3: Build the API into a Docker image
        stage('Build API Docker Image') {
            steps {
                script {
                    def dockerImage = docker.build("llm-api:${env.BUILD_NUMBER}")
                }
            }
        }

        // ## Stage 4: Run all tests against the live, running API
        stage('Run Automated Tests') {
            steps {
                script {
                    dockerImage.withRun { container ->
                        sh 'sleep 15'
                        sh 'npm install -g newman newman-reporter-htmlextra'
                        sh "newman run api_tests.postman_collection.json --reporters cli,htmlextra --reporter-htmlextra-export report.html"
                        sh "jmeter -n -t APIPerformanceTest.jmx -l performance-results.jtl"
                    }
                }
            }
        }
    }

    // ## Post-Build Actions: This section runs after all stages are finished
    post {
        always {
            publishHTML(target: [
                reportDir: '.', reportFiles: 'report.html', reportName: 'Functional Test Report'
            ])
            perfReport glob: 'performance-results.jtl'
            sh "docker rmi llm-api:${env.BUILD_NUMBER}"
        }
    }
}